-- 1. 
DROP TABLE HTL_SERVICO_QTDE;

CREATE TABLE HTL_SERVICO_QTDE (
    ID_HTL_SERVICO_QTDE INTEGER GENERATED BY DEFAULT AS IDENTITY,
    SERVICO_ID   INTEGER        NOT NULL,
    DATA_SERVICO           DATE        NOT NULL,
    QTDE_SERVICO           NUMBER(5,0)   NOT NULL,
    CONSTRAINT PK_HTL_SERVICO_QTDE PRIMARY KEY (ID_HTL_SERVICO_QTDE),
    CONSTRAINT FK_HTL_RQ_SERVICO FOREIGN KEY (SERVICO_ID)
        REFERENCES HTL_SERVICO (SERVICO_ID)
);

-- 2.

CREATE OR REPLACE PROCEDURE P_HTL_INIT_SERVICO_QTDE AS
BEGIN
    INSERT INTO HTL_SERVICO_QTDE (SERVICO_ID, DATA_SERVICO, QTDE_SERVICO)
    SELECT
        SERVICO_ID,
        CONCLUIDO_EM AS DATA_SERVICO,
        count(*) AS QTDE_SERVICO
    FROM HTL_RESERVA_SERVICO 
    GROUP BY SERVICO_ID, CONCLUIDO_EM;
END;

-- 3.
CREATE OR REPLACE PROCEDURE P_HTL_BUSCA_QUARTO (
    P_ID IN INTEGER,
    P_TOTAL_RESERVAS OUT NUMBER,
    P_MEDIA_SERVICO OUT NUMBER
) AS
BEGIN
    SELECT
    SUM(VALOR_CONTRATADO)
    INTO P_TOTAL_RESERVAS
    FROM HTL_RESERVA WHERE QUARTO_ID = P_ID AND CHECK_OUT IS NOT NULL;
    
    SELECT 
    AVG(VALOR)
    INTO P_MEDIA_SERVICO
    FROM HTL_RESERVA_SERVICO RS
    INNER JOIN HTL_RESERVA R ON RS.RESERVA_ID = R.RESERVA_ID
    WHERE R.QUARTO_ID = P_ID AND R.CHECK_OUT IS NOT NULL;
END;

-- 4.
CREATE OR REPLACE FUNCTION F_HTL_RESERVA_TOTAL_SERVICO(F_ID IN NUMBER)
RETURN NUMBER
AS
    TOTAL NUMBER;
BEGIN
    SELECT sum(VALOR) INTO TOTAL
    FROM HTL_RESERVA_SERVICO
    WHERE RESERVA_ID = F_ID;

    IF TOTAL IS NULL THEN
         TOTAL := 0;
    END IF;

    RETURN TOTAL;
END;

-- 5.
ALTER TABLE HTL_RESERVA
    ADD VALOR_SERVICOS NUMBER(5,0) DEFAULT 0 NOT NULL;

UPDATE HTL_RESERVA R 
    SET VALOR_SERVICOS = F_HTL_RESERVA_TOTAL_SERVICO(R.RESERVA_ID);
